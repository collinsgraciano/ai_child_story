<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>儿童故事图片视频生成工具</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="app-container">
        <!-- 顶部标题栏 -->
        <header class="header">
            <h1 class="title" id="storyTitle">儿童故事图片视频生成工具</h1>
            <button class="settings-btn" onclick="toggleSettings()" title="设置">⚙️</button>
        </header>

        <!-- 设置面板 (伸缩展开，可滚动) -->
        <div id="settingsPanel" class="settings-panel">
            <div class="settings-grid">
                <!-- 图片 API 设置 (V1) -->
                <div class="settings-column">
                    <h3>🖼️ 图片生成 API (V1)</h3>
                    <div class="form-group">
                        <label for="imageApiUrl">API 地址</label>
                        <input type="text" id="imageApiUrl" placeholder="http://example.com/v1">
                    </div>
                    <div class="form-group">
                        <label for="imageApiKey">API 密钥</label>
                        <input type="password" id="imageApiKey" placeholder="sk-xxx">
                    </div>
                    <div class="form-group">
                        <label for="imageModel">模型名称</label>
                        <input type="text" id="imageModel" placeholder="g3-img-pro">
                    </div>
                </div>

                <!-- 图片 API 设置 (V2 流式) -->
                <div class="settings-column">
                    <h3>🖼️ 图片生成 API (V2 流式)</h3>
                    <div class="form-group">
                        <label for="imageApiUrlV2">API 地址</label>
                        <input type="text" id="imageApiUrlV2" placeholder="http://127.0.0.1:8045/v1">
                    </div>
                    <div class="form-group">
                        <label for="imageApiKeyV2">API 密钥</label>
                        <input type="password" id="imageApiKeyV2" placeholder="sk-xxx">
                    </div>
                    <div class="form-group">
                        <label for="imageModelV2">模型名称</label>
                        <input type="text" id="imageModelV2" placeholder="gemini-3-pro-image-16-9">
                    </div>
                    <div class="form-group">
                        <label for="imageSizeV2">图片尺寸</label>
                        <input type="text" id="imageSizeV2" placeholder="4096x4096">
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">如 1024x1024,
                            4096x4096 等</small>
                    </div>
                </div>

                <!-- 视频 API 设置 -->
                <div class="settings-column">
                    <h3>🎬 视频生成 API</h3>
                    <div class="form-group">
                        <label for="videoApiUrl">API 地址</label>
                        <input type="text" id="videoApiUrl" placeholder="http://example.com/v1">
                    </div>
                    <div class="form-group">
                        <label for="videoApiKey">API 密钥</label>
                        <input type="password" id="videoApiKey" placeholder="sk-xxx">
                    </div>
                    <div class="form-group">
                        <label for="videoModel">模型名称</label>
                        <input type="text" id="videoModel" placeholder="sora">
                    </div>
                </div>

                <!-- 音频 API 设置 -->
                <div class="settings-column">
                    <h3>🔊 音频生成 API</h3>
                    <div class="form-group">
                        <label for="audioApiUrl">Gradio 地址</label>
                        <input type="text" id="audioApiUrl" placeholder="https://xxx.gradio.live">
                    </div>
                    <div class="form-group">
                        <label for="referenceAudioCn">中文参考音频路径</label>
                        <input type="text" id="referenceAudioCn" placeholder="d:\path\to\cn_ref.wav">
                    </div>
                    <div class="form-group">
                        <label for="referenceAudioEn">英文参考音频路径</label>
                        <input type="text" id="referenceAudioEn" placeholder="d:\path\to\en_ref.wav">
                    </div>
                </div>

                <!-- 提示词优化 API 设置 -->
                <div class="settings-column">
                    <h3>✨ 提示词优化 API</h3>
                    <div class="form-group">
                        <label for="optimizeApiUrl">API 地址</label>
                        <input type="text" id="optimizeApiUrl" placeholder="https://x666.me/v1">
                    </div>
                    <div class="form-group">
                        <label for="optimizeApiKey">API 密钥</label>
                        <input type="password" id="optimizeApiKey" placeholder="sk-xxx">
                    </div>
                    <div class="form-group">
                        <label for="optimizeModel">模型名称</label>
                        <input type="text" id="optimizeModel" placeholder="gpt-4.1-mini">
                    </div>
                    <div class="form-group">
                        <label for="imagePromptTemplate">图片优化提示模板</label>
                        <textarea id="imagePromptTemplate" rows="3" placeholder="使用 {prompt} 和 {narration} 作为占位符"
                            style="width: 100%; min-height: 60px; resize: vertical;"></textarea>
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">{prompt} = 原始提示词,
                            {narration} = 旁白</small>
                    </div>
                    <div class="form-group">
                        <label for="videoPromptTemplate">视频优化提示模板</label>
                        <textarea id="videoPromptTemplate" rows="3" placeholder="使用 {prompt} 和 {narration} 作为占位符"
                            style="width: 100%; min-height: 60px; resize: vertical;"></textarea>
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">{prompt} = 原始提示词,
                            {narration} = 旁白</small>
                    </div>
                </div>

                <!-- 生成配置 -->
                <div class="settings-column">
                    <h3>⚙️ 生成配置</h3>
                    <div class="form-group">
                        <label for="imageGeneratorMode">图片生成器</label>
                        <select id="imageGeneratorMode" style="width: 100%;">
                            <option value="v1">V1 (标准)</option>
                            <option value="v2">V2 (流式响应)</option>
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">V1: 标准 API; V2: 流式
                            chat.completions</small>
                    </div>
                    <div class="form-group">
                        <label for="batchSize">每次生成数量</label>
                        <input type="number" id="batchSize" min="1" max="5" value="1" placeholder="默认: 1">
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">多张图将保存为变体，前端默认显示第一张。</small>
                    </div>
                    <div class="form-group">
                        <label for="concurrencyImage">图片并发数</label>
                        <input type="number" id="concurrencyImage" min="1" max="5" value="2" placeholder="默认: 2">
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">同时生成的图片任务数量。</small>
                    </div>
                    <div class="form-group">
                        <label for="concurrencyVideo">视频并发数</label>
                        <input type="number" id="concurrencyVideo" min="1" max="5" value="1" placeholder="默认: 1">
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">同时生成的视频任务数量。</small>
                    </div>
                    <div class="form-group">
                        <label for="imageMaxRetries">图片失败重试次数</label>
                        <input type="number" id="imageMaxRetries" min="0" max="10" value="3" placeholder="默认: 3">
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">图片生成失败后的重试次数。</small>
                    </div>
                    <div class="form-group">
                        <label for="videoMaxRetries">视频失败重试次数</label>
                        <input type="number" id="videoMaxRetries" min="0" max="20" value="10" placeholder="默认: 10">
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">视频生成失败后的重试次数。</small>
                    </div>
                    <div class="form-group">
                        <label for="defaultStyle">默认风格</label>
                        <select id="defaultStyle" style="width: 100%;">
                            <option value="">-- 无默认风格 --</option>
                        </select>
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">启动时自动选择的风格参考。</small>
                    </div>
                </div>

                <!-- 视频后处理设置 -->
                <div class="settings-column">
                    <h3>🎞️ 视频后处理</h3>
                    <div class="form-group">
                        <label for="sceneThreshold">场景检测阈值</label>
                        <input type="number" id="sceneThreshold" step="0.1" min="1" max="100" value="27.0"
                            placeholder="默认: 27.0">
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">值越大检测越宽松，用于分割视频镜头。</small>
                    </div>
                    <div class="form-group">
                        <label for="videoVolume">原视频音量</label>
                        <input type="number" id="videoVolume" step="0.01" min="0" max="5" value="0.05"
                            placeholder="默认: 0.05">
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">0.05 =
                            5%，原视频的背景音量。</small>
                    </div>
                    <div class="form-group">
                        <label for="audioVolume">配音音量</label>
                        <input type="number" id="audioVolume" step="0.1" min="0" max="10" value="4.0"
                            placeholder="默认: 4.0">
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">4.0 =
                            400%，配音声音的音量。</small>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="skipFirstScene" checked style="width: auto;">
                            <span>删除第一个镜头</span>
                        </label>
                        <small
                            style="color: var(--text-secondary); display: block; margin-top: 4px;">自动检测并删除每个视频的首个场景（通常是转场）。</small>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSettings()">
                    <span class="btn-icon">💾</span> 保存设置
                </button>
            </div>
        </div>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- JSON 输入区域 -->
            <section class="json-input-section">
                <div class="section-header">
                    <h2 class="section-title">📄 故事数据</h2>
                    <div class="section-actions">
                        <!-- 项目选择器 -->
                        <select id="projectSelector" class="project-selector" onchange="switchProject(this.value)">
                            <option value="">-- 选择项目 --</option>
                        </select>
                        <button class="btn btn-danger btn-icon-only" onclick="deleteCurrentProject()" title="删除当前项目"
                            id="deleteProjectBtn">
                            🗑️
                        </button>
                        <button class="btn btn-primary" onclick="loadJsonInput()" id="loadJsonBtn">
                            <span class="btn-icon">📥</span> 加载 JSON
                        </button>
                        <button class="btn btn-secondary" onclick="toggleJsonInput()">
                            <span class="btn-icon">📝</span> <span id="toggleJsonText">展开输入</span>
                        </button>
                    </div>
                </div>
                <div class="json-input-wrapper" id="jsonInputWrapper" style="display: none;">
                    <textarea id="jsonInput"
                        placeholder="粘贴故事 JSON 数据到这里...&#10;&#10;必须包含以下字段：&#10;- title: 故事标题&#10;- script: 分镜数组，每项包含 page_index 和 image_prompt"></textarea>
                    <div class="json-input-info">
                        <span id="jsonStatus">等待输入</span>
                    </div>
                </div>
            </section>

            <!-- 设计稿区域 -->
            <section class="design-sheets">
                <h2 class="section-title">📋 设计稿</h2>
                <p class="section-desc">首先生成角色和场景设计稿，作为后续所有分镜的参考</p>

                <!-- 风格选择器 -->
                <div class="style-selector"
                    style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                    <span style="font-weight: 600;">🎨 风格参考:</span>
                    <select id="styleSelect" onchange="selectStyle(this.value)"
                        style="flex: 1; max-width: 200px; padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-primary);">
                        <option value="">-- 无风格 --</option>
                    </select>
                    <button class="btn btn-secondary" onclick="document.getElementById('styleFileInput').click()"
                        style="padding: 8px 12px;">
                        <span class="btn-icon">📤</span> 上传新风格
                    </button>
                    <input type="file" id="styleFileInput" accept="image/*" style="display: none;"
                        onchange="uploadStyleFile(this)">
                    <button class="btn btn-danger" onclick="deleteCurrentStyle()" id="deleteStyleBtn"
                        style="padding: 8px 12px; display: none;">
                        <span class="btn-icon">🗑️</span> 删除
                    </button>
                    <div id="stylePreview"
                        style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; border: 2px solid var(--border-color); display: none;">
                        <img id="stylePreviewImg" src="" alt="style"
                            style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>

                <!-- 一键生成按钮 -->
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="generateAllSheets()" style="width: auto;">
                        <span class="btn-icon">🚀</span> 一键生成设计稿 (角色 → 场景)
                    </button>
                </div>

                <div class="sheets-grid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px;">
                    <!-- 角色设计稿 -->
                    <div class="page-card" id="characterSheet"
                        style="background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-lg);">
                        <div class="page-header"
                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(99,102,241,0.2);">
                            <span style="font-weight: 600;">👤 角色设计稿</span>
                            <span class="status-badge" id="characterStatus">未生成</span>
                        </div>
                        <div class="sheet-preview" id="characterPreview"
                            style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2);">
                            <div class="placeholder" style="text-align: center; color: var(--text-secondary);">
                                <span style="font-size: 2rem;">🎨</span>
                                <p style="margin-top: 8px;">点击下方按钮生成</p>
                            </div>
                        </div>
                        <div class="prompt-section" style="padding: 15px;">
                            <label
                                style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; display: block;">📝
                                提示词</label>
                            <textarea id="characterPromptInput"
                                style="width: 100%; min-height: 80px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); padding: 10px; resize: vertical; font-size: 13px;"
                                onchange="updateSheetPrompt('character_sheet_prompt', this.value)"></textarea>
                        </div>
                        <div style="padding: 0 15px 15px;">
                            <button class="btn btn-primary" onclick="generateCharacterSheet()" style="width: 100%;">
                                <span class="btn-icon">✨</span> 生成角色设计稿
                            </button>
                        </div>
                    </div>

                    <!-- 场景设计稿 -->
                    <div class="page-card" id="sceneSheet"
                        style="background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-lg);">
                        <div class="page-header"
                            style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(139,92,246,0.2);">
                            <span style="font-weight: 600;">🏞️ 场景设计稿</span>
                            <span class="status-badge" id="sceneStatus">未生成</span>
                        </div>
                        <div class="sheet-preview" id="scenePreview"
                            style="min-height: 200px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2);">
                            <div class="placeholder" style="text-align: center; color: var(--text-secondary);">
                                <span style="font-size: 2rem;">🖼️</span>
                                <p style="margin-top: 8px;">点击下方按钮生成</p>
                            </div>
                        </div>
                        <div class="prompt-section" style="padding: 15px;">
                            <label
                                style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; display: block;">📝
                                提示词</label>
                            <textarea id="scenePromptInput"
                                style="width: 100%; min-height: 80px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); padding: 10px; resize: vertical; font-size: 13px;"
                                onchange="updateSheetPrompt('scene_sheet_prompt', this.value)"></textarea>
                        </div>
                        <div style="padding: 0 15px 15px;">
                            <button class="btn btn-primary" onclick="generateSceneSheet()" style="width: 100%;">
                                <span class="btn-icon">✨</span> 生成场景设计稿
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 分镜区域 -->
            <section class="storyboard">
                <div class="section-header">
                    <h2 class="section-title">🎬 分镜画面</h2>
                    <div class="section-actions">
                        <button class="btn btn-secondary" onclick="generateAllImages()">
                            <span class="btn-icon">📦</span> 批量生成分镜
                        </button>
                        <button class="btn btn-secondary" onclick="generateAllVideos()">
                            <span class="btn-icon">🎥</span> 批量生成视频
                        </button>
                        <button class="btn btn-secondary" onclick="generateAllAudio()">
                            <span class="btn-icon">🔊</span> 批量生成配音
                        </button>
                        <button class="btn btn-secondary" onclick="generateProjectSRT()">
                            <span class="btn-icon">📝</span> 生成字幕 (SRT)
                        </button>
                        <button class="btn btn-secondary" onclick="optimizeAllVideoPrompts()">
                            <span class="btn-icon">✨</span> 批量优化视频提示词
                        </button>
                        <button class="btn btn-secondary" onclick="optimizeAllImagePrompts()">
                            <span class="btn-icon">🎨</span> 批量优化图片提示词
                        </button>
                    </div>
                </div>

                <div class="pages-grid" id="pagesGrid">
                    <!-- 页面卡片将由 JS 动态生成 -->
                    <div class="loading-placeholder">
                        <div class="spinner"></div>
                        <p>加载故事数据中...</p>
                    </div>
                </div>

                <!-- 最终视频生成与预览区域 -->
                <div class="final-video-section"
                    style="margin-top: 30px; padding: 20px; background: rgba(99,102,241,0.1); border-radius: 12px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 16px;">🎬 最终视频</h3>

                    <!-- 生成按钮区 -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="generateFinalVideo('cn')" id="generateFinalVideoCnBtn">
                            <span class="btn-icon">🇨🇳</span> 生成中文版
                        </button>
                        <button class="btn btn-primary" onclick="generateFinalVideo('en')" id="generateFinalVideoEnBtn">
                            <span class="btn-icon">🇬🇧</span> 生成英文版
                        </button>
                        <button class="btn btn-secondary" onclick="loadFinalVideos()">
                            <span class="btn-icon">🔄</span> 刷新预览
                        </button>
                    </div>

                    <!-- 双语视频预览区 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <!-- 中文版 -->
                        <div class="video-preview-card"
                            style="background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-md);">
                            <div
                                style="padding: 10px 15px; background: rgba(239,68,68,0.2); display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">🇨🇳 中文版</span>
                                <span id="finalVideoCnStatus"
                                    style="font-size: 12px; color: var(--text-secondary);">未生成</span>
                            </div>
                            <div id="finalVideoCnPreview"
                                style="background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: #666; text-align: center;">点击"生成中文版"开始</p>
                            </div>
                            <div style="padding: 10px 15px; display: flex; gap: 10px;">
                                <a id="finalVideoCnDownload" href="#" download
                                    style="display: none; flex: 1; text-align: center; padding: 8px; background: var(--success-color); color: white; border-radius: 8px; text-decoration: none;">
                                    📥 下载
                                </a>
                            </div>
                        </div>

                        <!-- 英文版 -->
                        <div class="video-preview-card"
                            style="background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-md);">
                            <div
                                style="padding: 10px 15px; background: rgba(59,130,246,0.2); display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">🇬🇧 英文版</span>
                                <span id="finalVideoEnStatus"
                                    style="font-size: 12px; color: var(--text-secondary);">未生成</span>
                            </div>
                            <div id="finalVideoEnPreview"
                                style="background: #000; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: #666; text-align: center;">点击"生成英文版"开始</p>
                            </div>
                            <div style="padding: 10px 15px; display: flex; gap: 10px;">
                                <a id="finalVideoEnDownload" href="#" download
                                    style="display: none; flex: 1; text-align: center; padding: 8px; background: var(--success-color); color: white; border-radius: 8px; text-decoration: none;">
                                    📥 下载
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- 底部状态栏 -->
        <footer class="footer">
            <div class="progress-info">
                <span id="progressText">就绪</span>
            </div>
        </footer>



        <!-- 图片预览模态框 -->
        <div class="modal" id="imageModal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <img id="modalImage" src="" alt="预览">
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="regenerateCurrentImage()">
                        <span class="btn-icon">🔄</span> 重新生成
                    </button>
                </div>
            </div>
        </div>

        <!-- 视频预览模态框 -->
        <div class="modal" id="videoModal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeVideoModal()">&times;</span>
                <video id="modalVideo" controls></video>
                <div class="modal-actions">
                    <button class="btn btn-danger" onclick="regenerateCurrentVideo()">
                        <span class="btn-icon">🔄</span> 重新生成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>

</html>